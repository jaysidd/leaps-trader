# Session: January 31, 2025

## Objective
Add webhook integration for trading bot signal provider alerts.

## Features Implemented

### 1. Alerts Tab on Screener Page
- Added new "Alerts" tab after "Manual Stocks" tab
- Displays webhook alerts in card format similar to scanner results
- Support for multiple webhook providers (extensible design)
- Filtering by provider, status, and event type
- Pagination for large alert lists
- Statistics summary (total, active, triggered, etc.)

### 2. Webhook Endpoint (Backend)
- **Endpoint**: `POST /api/v1/webhooks/receive/{provider}`
- Receives POST requests with trading signals
- Two event types supported: `new_setup` and `trigger`
- Stores alerts in PostgreSQL database
- Updates existing alerts when triggered

### 3. Alert Management API
- `GET /api/v1/webhooks/alerts` - List alerts with filters
- `GET /api/v1/webhooks/alerts/{id}` - Get single alert
- `PATCH /api/v1/webhooks/alerts/{id}/status` - Update status
- `DELETE /api/v1/webhooks/alerts/{id}` - Delete alert
- `DELETE /api/v1/webhooks/alerts` - Clear multiple alerts
- `GET /api/v1/webhooks/providers` - List providers
- `GET /api/v1/webhooks/stats` - Get statistics

### 4. Alert Details View
- When clicking "Details" on an alert, shows full trade setup
- Position sizing calculator
- Stock screening integration (fetches full analysis)
- Chart view with TradingView widget
- Sentiment analysis integration

## Webhook Payload Structure
```json
{
  "event_type": "string",       // "new_setup" or "trigger"
  "setup_id": "string",         // Unique identifier for the setup
  "symbol": "string",           // Trading pair (e.g., "BTCUSD", "AAPL")
  "direction": "string",        // "buy" or "sell"
  "entry_zone": [float, float], // Array containing [min_entry, max_entry]
  "stop_loss": float,           // Stop Loss price
  "tp1": float,                 // Take Profit 1 price
  "tp2": float,                 // Take Profit 2 price
  "current_price": float,       // Live price at the time of the event
  "timestamp": "iso-string"     // UTC timestamp (ISO 8601)
}
```

## Files Created

### Backend
- [x] `backend/app/models/webhook_alert.py` - SQLAlchemy model for webhook alerts
- [x] `backend/app/api/endpoints/webhooks.py` - FastAPI router with all webhook endpoints
- [x] `backend/app/models/__init__.py` - Updated to export WebhookAlert
- [x] `backend/app/main.py` - Registered webhooks router

### Frontend
- [x] `frontend/src/components/alerts/AlertsTab.jsx` - Main alerts list component
- [x] `frontend/src/components/alerts/AlertCard.jsx` - Individual alert card
- [x] `frontend/src/components/alerts/AlertDetail.jsx` - Full alert detail modal
- [x] `frontend/src/components/alerts/index.js` - Component exports
- [x] `frontend/src/api/alerts.js` - API client for webhooks
- [x] `frontend/src/api/screener.js` - Added export for screenSingleStock
- [x] `frontend/src/pages/Screener.jsx` - Added Alerts tab

## Configuration

### Webhook URL for Signal Provider
Configure your signal provider to send webhooks to:
```
POST http://your-server:8000/api/v1/webhooks/receive/{provider_name}
```

Replace `{provider_name}` with a unique identifier for each signal provider (e.g., "tradingbot", "signals_premium").

### Example: New Setup Webhook
```bash
curl -X POST http://localhost:8000/api/v1/webhooks/receive/tradingbot \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "new_setup",
    "setup_id": "550e8400-e29b-41d4-a716-446655440000",
    "symbol": "AAPL",
    "direction": "buy",
    "entry_zone": [175.00, 177.50],
    "stop_loss": 170.00,
    "tp1": 185.00,
    "tp2": 195.00,
    "current_price": 176.25,
    "timestamp": "2025-01-31T12:00:00.000000+00:00"
  }'
```

### Example: Trigger Webhook
```bash
curl -X POST http://localhost:8000/api/v1/webhooks/receive/tradingbot \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "trigger",
    "setup_id": "550e8400-e29b-41d4-a716-446655440000",
    "symbol": "AAPL",
    "direction": "buy",
    "entry_zone": [175.00, 177.50],
    "stop_loss": 170.00,
    "tp1": 185.00,
    "tp2": 195.00,
    "current_price": 175.50,
    "timestamp": "2025-01-31T12:15:30.123456+00:00"
  }'
```

## Database Migration
The webhook alerts table will be created automatically when the backend starts (via SQLAlchemy's `create_all`).

If you need to manually create the table:
```sql
CREATE TABLE webhook_alerts (
    id SERIAL PRIMARY KEY,
    provider VARCHAR(100) NOT NULL DEFAULT 'default',
    setup_id VARCHAR(255) NOT NULL UNIQUE,
    event_type VARCHAR(50) NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    direction VARCHAR(10) NOT NULL,
    entry_zone_min FLOAT,
    entry_zone_max FLOAT,
    stop_loss FLOAT,
    tp1 FLOAT,
    tp2 FLOAT,
    current_price FLOAT,
    alert_timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    received_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'active',
    raw_payload JSONB
);

CREATE INDEX idx_alert_symbol ON webhook_alerts(symbol);
CREATE INDEX idx_alert_provider ON webhook_alerts(provider);
CREATE INDEX idx_alert_status ON webhook_alerts(status);
CREATE INDEX idx_alert_received ON webhook_alerts(received_at);
CREATE INDEX idx_alert_event_type ON webhook_alerts(event_type);
```

## Testing
1. Start the backend: `cd backend && python -m uvicorn app.main:app --reload`
2. Start the frontend: `cd frontend && npm run dev`
3. Navigate to Screener page and click on "Alerts" tab
4. Send a test webhook using the curl commands above
5. Refresh the Alerts tab to see the new alert
6. Click "View Details" to see full alert information

## Cloudflare Tunnel Configuration (February 1, 2025)

### Permanent Webhook URL
```
https://webhook.leapstraders.com/api/v1/webhooks/receive/finradar
```

### Tunnel Details
| Item | Value |
|------|-------|
| **Tunnel Name** | `leaps-trader-webhook` |
| **Tunnel ID** | `16e0a778-e968-4f24-aa4b-f4df9ef05a63` |
| **Domain** | `leapstraders.com` |
| **Subdomain** | `webhook.leapstraders.com` |
| **Routes to** | `http://localhost:8000` |

### Configuration Files
- **Tunnel Config**: `~/.cloudflared/config.yml`
- **Credentials**: `~/.cloudflared/16e0a778-e968-4f24-aa4b-f4df9ef05a63.json`

### Running the Tunnel
```bash
# Start tunnel manually
cloudflared tunnel run leaps-trader-webhook

# Install as system service (auto-start on boot)
sudo cloudflared service install
```

### FinRadar Webhook Configuration
| Field | URL |
|-------|-----|
| **New Setup Endpoint** | `https://webhook.leapstraders.com/api/v1/webhooks/receive/finradar` |
| **Trigger Endpoint** | `https://webhook.leapstraders.com/api/v1/webhooks/receive/finradar` |

### CORS Configuration Updated
Added to `backend/app/config.py`:
```python
BACKEND_CORS_ORIGINS: list = [
    "http://localhost:3000",
    "http://localhost:5173",
    "http://localhost:5174",
    "http://localhost:5175",
    "http://localhost:5176",
    "https://webhook.leapstraders.com",
    "https://leapstraders.com",
]
```

## Next Steps (Future Enhancements)
- [ ] Real-time WebSocket updates for new alerts
- [ ] Push notifications for triggered alerts
- [ ] Alert history and analytics
- [ ] Integration with position tracking
- [ ] Email/SMS notifications
- [ ] Alert sound notifications
- [ ] Bulk alert management
